digraph HyPCAR {
  rankdir=TB;
  graph [
    label="HyPCAR Data Generation",
    labelloc=t,
    fontsize=200,
    margin=0.5,
    nodesep=1.2,
    ranksep=1.2,
    splines=true,
    compound=true,
    fontname="roboto",
    bgcolor="white"
  ];
  
  node [
    fontname="Roboto",
    fontsize=100,
    shape=box,
    style=rounded,
    penwidth=2.5,
    margin="0.7,0.4",
    height=0.9,
    width=3.2
  ];
  
  edge [
    fontname="Roboto",
    fontsize=80,
    penwidth=2.5,
    arrowsize=1.6,
    minlen=3,
    labelangle=0,
    labeldistance=2.0
  ];
  
  // ─── Elevate Decision Nodes ───────────────────────────────────────
  // { rank=source; atmoCheck; mixCheck; }
  
  // ─── Initial Parameters ─────────────────────────────────────────────────────────
  subgraph cluster_DataGen {
    label=<<B>Initial Parameters</B>>;
    labelloc=t;
    fontsize=100;
    color="#A385E8";
    style=filled;
    fillcolor="#F3E5FF";
    margin=20;
    padding=20;
    
    atmoType [ label="Atmosphere Type\n(A1, A2, B, C, None)", shape=oval, style=filled, fillcolor="#D1C4E9", fontsize=90 ];
    starType [ label="Stellar Type\n(M, G, K)", shape=oval, style=filled, fillcolor="#D1C4E9", fontsize=90 ];
    lhsSample [ label="Sample Parameters\n(LHS)", style=filled, fillcolor="#E1BEE7", fontsize=90 ];
  }
  
  // ─── Stellar Parameters ───────────────────────────────────────────────────────
  subgraph cluster_Stellar {
    label=<<B>Stellar Parameters</B>>;
    labelloc=t;
    fontsize=100;
    color="#64B5F6";
    style=filled;
    fillcolor="#E3F2FD";
    margin=20;
    padding=20;
    
    radTemp   [ label="Determine Stellar\nRadius & Temperature", style=filled, fillcolor="#BBDEFB", fontsize=90 ];
    starLum   [ label="Calculate Star\nLuminosity\n(4πR²σT⁴)", style=filled, fillcolor="#BBDEFB", fontsize=90 ];
    smaBounds [ label="Calculate Habitable\nZone Bounds", style=filled, fillcolor="#BBDEFB", fontsize=90 ];
  }
  
  // ─── Planetary Parameters ────────────────────────────────────────────────────
  subgraph cluster_Planetary {
    label=<<B>Planetary Parameters</B>>;
    labelloc=t;
    fontsize=100;
    color="#FFB74D";
    style=filled;
    fillcolor="#FFF3E0";
    margin=20;
    padding=20;
    
    genPlanet [ label="Generate Planetary\nParameters", style=filled, fillcolor="#FFE0B2", fontsize=90 ];
    pt        [ label="Calculate Pressure–\nTemperature Profile", style=filled, fillcolor="#FFE0B2", fontsize=90 ];
  }
  
  // ─── Atmospheric Parameters ───────────────────────────────────────────────────
  subgraph cluster_AtmChem {
    label=<<B>Atmospheric Parameters</B>>;
    labelloc=t;
    fontsize=100;
    color="#4DB6AC";
    style=filled;
    fillcolor="#E0F2F1";
    margin=20;
    padding=20;
    
    hconSample    [ label="Sample Elemental\nAbundances", style=filled, fillcolor="#B2DFDB", fontsize=90 ];
    calcAbundance [ label="Calculate Molecular\nAbundances", style=filled, fillcolor="#B2DFDB", fontsize=90 ];
  }
  
  // ─── Checks ────────────────────────────────────────────────────────────────
  subgraph cluster_Decisions {
    label=<<B>Checks</B>>;
    labelloc=t;
    fontsize=100;
    color="#FFF176";
    style=filled;
    fillcolor="#FFFBCC";
    margin=20;
    padding=20;
    
    atmoCheck [ label="Check Atmospheric\nViability", style=filled, fillcolor="#FFF59D", fontsize=90 ];
    mixCheck [ label="Validate Mixing\nRatios", style=filled, fillcolor="#FFF59D", fontsize=90 ];
  }
  
  // ─── Radiative Transfer & Output ─────────────────────────────────────────────
  subgraph cluster_Radiative {
    label=<<B>Radiative Transfer</B>>;
    labelloc=t;
    fontsize=100;
    color="#F48FB1";
    style=filled;
    fillcolor="#FCE4EC";
    margin=20;
    padding=20;
    
    psg     [ label="Run Radiative\nTransfer (PSG)", style=filled, fillcolor="#F8BBD0", fontsize=90 ];
    spectra [ label="Transmittance\nSpectra", shape=oval, style=filled, fillcolor="#C8E6C9", fontsize=90 ];
  }
  
  // ─── Edges ───────────────────────────────────────────────────────────────────
  starType    -> lhsSample;
  atmoType    -> hconSample;
  lhsSample   -> radTemp;
  radTemp     -> starLum;
  starLum     -> smaBounds;
  smaBounds   -> genPlanet;
  genPlanet   -> atmoCheck;

    // Decision Edges: straight, ported, no overlap
  atmoCheck:s -> genPlanet:n [style=dashed, color="#E53935", fontcolor="#E53935", penwidth=5,
      label="No", labelfontname="Roboto", fontsize=140, labeldistance=2.0, labelangle=0];
  atmoCheck:e -> pt:w       [color="#43A047", fontcolor="#43A047", penwidth=5,
      label="Yes", labelfontname="Roboto", fontsize=140, labeldistance=2.0, labelangle=0];

  hconSample -> mixCheck;
  mixCheck:s -> calcAbundance:n [style=dashed, color="#E53935", fontcolor="#E53935", penwidth=5,
      label="No", labelfontname="Roboto", fontsize=140, labeldistance=2.0, labelangle=0];
  mixCheck:e -> calcAbundance:w [color="#43A047", fontcolor="#43A047", penwidth=5,
      label="Yes", labelfontname="Roboto", fontsize=140, labeldistance=2.0, labelangle=0];

  // ─── Radiative Transfer Connections ───────────────────────────────────────
  genPlanet -> psg;
  pt        -> psg;
  radTemp   -> psg;
  starLum   -> psg;
  starType  -> psg;
  calcAbundance -> psg;
  psg       -> spectra;
}